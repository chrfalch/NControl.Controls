using System;
using Xamarin.Forms;
using NControl.Abstractions;
using System.Threading.Tasks;

namespace NControl.Controls
{
    public enum CardPosition
    {
        Custom,
        Top,
        Bottom,
        Center
    }

    public enum EdgePosition
    {
        Left,
        Right,
        Top,
        Bottom
    }

    /// <summary>
	/// Card page. Based on custom transitions 
	/// </summary>
	public class CardPage: ContentPage
	{				
		#region Private Members

		/// <summary>
		/// The height of the requested.
		/// </summary>
		private double _requestedHeight = -1;

		/// <summary>
		/// The width of the requested.
		/// </summary>
		private double _requestedWidth = -1;

		/// <summary>
		/// The helper.
		/// </summary>
		private ICardPageHelper _platformHelper;

		/// <summary>
		/// The shadow.
		/// </summary>
		private readonly Frame _shadowLayer;

		/// <summary>
		/// The layout.
		/// </summary>
		private readonly RelativeLayout _layout;

		/// <summary>
		/// The overlay.
		/// </summary>
		private readonly BoxView _overlay;

		/// <summary>
		/// The overlay.
		/// </summary>
		private readonly ContentView _contentView;

		#endregion

		/// <summary>
		/// Initializes a new instance of the <see cref="NControl.Controls.CardPage"/> class.
		/// </summary>
		public CardPage()
		{					
			// Get helper
			_platformHelper = DependencyService.Get<ICardPageHelper> ();
            if(_platformHelper == null)
                throw new InvalidOperationException("Error loading NControls - did you remember to call " + 
                    "NControls.Init() in your platform startup code?");

			_cardPadding = new Thickness (40, 100, 40, 100);
			BackgroundColor = Color.Transparent;
            _hasHaddow = true;

			NavigationPage.SetHasNavigationBar (this, true);
			NavigationPage.SetHasBackButton (this, false);

			_layout = new RelativeLayout ();
			base.Content = _layout;

			// Shadow 
			_shadowLayer = new Frame{
				BackgroundColor = Color.White,
				HasShadow = Device.OnPlatform<bool>(true, false, false),
			};

			_overlay = new BoxView {
				BackgroundColor = Color.Black,
				Opacity = 0.0F,
			};

            if (_platformHelper.ControlAnimatesItself)
            {
                // Card 
                _contentView = new RoundCornerView {
                    BackgroundColor = Color.White,
                    CornerRadius = 2,
                };

                _layout.Children.Add(_overlay, () => _layout.Bounds);

                _layout.Children.Add(_shadowLayer, () => this.LayerPosition);

                _layout.Children.Add(_contentView, () => this.LayerPosition);

                // Add tap
                _overlay.GestureRecognizers.Add(new TapGestureRecognizer
                {
                    Command = new Command(async () => await CloseAsync())
                });
            }
            else
            {
                // Card 
                _contentView = new ContentView {
                    BackgroundColor = Color.White,                    
                };

                _layout.Children.Add(_contentView, () => 
                    _layout.Bounds);
            }
        }

        private Rectangle LayerPosition 
        { 
            get 
            { 
                if (!_platformHelper.ControlAnimatesItself)
                    return new Rectangle(0, 0, _layout.Width, _layout.Height);

                if (Position == CardPosition.Custom)
                {
                    return new Rectangle(CardPadding.Left, CardPadding.Top,
                        _layout.Width - CardPadding.Left - CardPadding.Right,
                        _layout.Height - CardPadding.Bottom - CardPadding.Top);
                }
                var screen = _platformHelper.GetScreenSize();
                var width = WidthRequest > 0 
                    ? RequestedWidth 
                    : (_contentView.Content.Width < 0 ? _layout.Width : _contentView.Content.Width);

                var height = HeightRequest > 0 
                    ? RequestedHeight
                    : (_contentView.Content.Height < 0 ? _layout.Height : _contentView.Content.Height);

                var dx = (screen.Width - width) / 2;
                var dy = (screen.Height - height) / 2;

                if (Position == CardPosition.Bottom)
                    return new Rectangle(dx,2 * dy, width, height);
                if (Position == CardPosition.Center)
                    return new Rectangle(dx, dy, width, height);

                return new Rectangle(dx, 0, width, height);
            } 
        }

		/// <summary>
		/// Raises the appearing event.
		/// </summary>
		protected override void OnAppearing ()
		{
			base.OnAppearing ();

			if (_platformHelper.ControlAnimatesItself) 
            {
				_overlay.FadeTo (0.5F);
				_shadowLayer.TranslateTo (0.0, 0.0, 150, Easing.CubicInOut);
				_contentView.TranslateTo (0.0, 0.0, 150, Easing.CubicInOut);
			} 
		}

		/// <param name="x">Left-hand side of layout area.</param>
		/// <param name="y">Top of layout area.</param>
		/// <param name="width">Width of layout area.</param>
		/// <param name="height">Height of layout area.</param>
		/// <summary>
		/// Layouts the children.
		/// </summary>
		protected override void LayoutChildren (double x, double y, double width, double height)
		{
			base.LayoutChildren (x, y, width, height);
			((Layout)_contentView.Content).ForceLayout ();
			var l = _contentView.Content.Bounds;
		}

		#region Properties

		/// <summary>
		/// Gets or sets the height of the requested.
		/// </summary>
		/// <value>The height of the requested.</value>
		public virtual double RequestedHeight 
		{			
			get { return _requestedHeight; }
			set 
			{
				var height = value;
				var padding = (_platformHelper.GetScreenSize().Height - height)/2;
                CardPadding = new Thickness (CardPadding.Left, padding, CardPadding.Right, padding);

				_requestedHeight = value;
				InvalidateMeasure ();
			}
		}

        /// <summary>
        /// Gets or sets the width of the requested.
        /// </summary>
        /// <value>The width of the requested.</value>
        public virtual double RequestedWidth 
        {           
            get { return _requestedWidth; }
            set 
            {
                var padding = (_platformHelper.GetScreenSize().Width - value)/2;
                CardPadding = new Thickness (padding, CardPadding.Top, padding, CardPadding.Bottom);

                _requestedWidth = value;
                InvalidateMeasure ();
            }
        }   

        private bool _hasHaddow;
        public bool HasShaddow
        {
            get { return _hasHaddow; }
            set 
            {
                if (_hasHaddow == value) return;
                _hasHaddow = value;

				_shadowLayer.IsVisible = value;
            }
        }

        private CardPosition _position = CardPosition.Custom;
        public CardPosition Position
        {
            get { return _position; }
            set 
            {
                if (_position == value) return;
                _position = value;
            }
        }

        private EdgePosition _edge = EdgePosition.Bottom;
        public EdgePosition Edge
        {
            get { return _edge; }
            set
            {
                if (_edge == value) return;
                _edge = value;

                if (_platformHelper.ControlAnimatesItself)
                {
                    switch (Edge)
                    {
                        case EdgePosition.Top:
                            _shadowLayer.TranslationX = 0;
                            _contentView.TranslationX = 0;
                            _shadowLayer.TranslationY = 0 - _platformHelper.GetScreenSize().Height + (CardPadding.Bottom);
                            _contentView.TranslationY = 0 - _platformHelper.GetScreenSize().Height + (CardPadding.Bottom);
                            break;
                        case EdgePosition.Bottom:
                            _shadowLayer.TranslationX = 0;
                            _contentView.TranslationX = 0;
                            _shadowLayer.TranslationY = _platformHelper.GetScreenSize().Height - (CardPadding.Top);
                            _contentView.TranslationY = _platformHelper.GetScreenSize().Height - (CardPadding.Top);
                            break;
                        case EdgePosition.Left:
                            _shadowLayer.TranslationX = 0 - _platformHelper.GetScreenSize().Width + (CardPadding.Right);
                            _contentView.TranslationX = 0 - _platformHelper.GetScreenSize().Width + (CardPadding.Right);
                            _shadowLayer.TranslationY = 0;
                            _contentView.TranslationY = 0;
                            break;
                        case EdgePosition.Right:
                            _shadowLayer.TranslationX = _platformHelper.GetScreenSize().Width - (CardPadding.Left);
                            _contentView.TranslationX = _platformHelper.GetScreenSize().Width - (CardPadding.Left);
                            _shadowLayer.TranslationY = 0;
                            _contentView.TranslationY = 0;
                            break;
                        default:
                            throw new ArgumentException(nameof(Edge));
                    }
                }

            }
        }

        private Thickness _cardPadding;
        public Thickness CardPadding 
        {
            get { return _cardPadding; }
            set 
            { 
                _cardPadding = value;
                Position = CardPosition.Custom;
            }
        }	

		/// <summary>
		/// Gets or Sets the View element representing the content of the Page.
		/// </summary>
		/// <value>The content.</value>
		public new View Content
		{
			get { return _contentView.Content; }
			set { _contentView.Content = value; }
		}

		#endregion

		#region Public Members

		/// <summary>
		/// Shows the card async
		/// </summary>
		/// <returns>The async.</returns>
		public virtual Task ShowAsync()
		{
			return _platformHelper.ShowAsync (this);
		}

		/// <summary>
		/// Closes the async.
		/// </summary>
		/// <returns>The async.</returns>
		public virtual async Task CloseAsync()
		{
			if (_platformHelper.ControlAnimatesItself) {
                var tasks = new Task[3];
                switch (Edge)
                {
                    case EdgePosition.Top:
                        tasks[0] = _shadowLayer.TranslateTo(0.0, 0 - _platformHelper.GetScreenSize().Height + (CardPadding.Bottom), 250, Easing.CubicInOut);
                        tasks[1] = _contentView.TranslateTo(0.0, 0 - _platformHelper.GetScreenSize().Height + (CardPadding.Bottom), 250, Easing.CubicInOut);
                        break;
                    case EdgePosition.Bottom:
                        tasks[0] = _shadowLayer.TranslateTo(0.0, _platformHelper.GetScreenSize().Height - (CardPadding.Top), 250, Easing.CubicInOut);
                        tasks[1] = _contentView.TranslateTo(0.0, _platformHelper.GetScreenSize().Height - (CardPadding.Top), 250, Easing.CubicInOut);
                        break;
                    case EdgePosition.Left:
                        tasks[0] = _shadowLayer.TranslateTo(0 - _platformHelper.GetScreenSize().Width + (CardPadding.Right), 0.0, 250, Easing.CubicInOut);
                        tasks[1] = _contentView.TranslateTo(0 - _platformHelper.GetScreenSize().Width + (CardPadding.Right), 0.0, 250, Easing.CubicInOut);
                        break;
                    case EdgePosition.Right:
                        tasks[0] = _shadowLayer.TranslateTo(_platformHelper.GetScreenSize().Width - (CardPadding.Left), 0.0, 250, Easing.CubicInOut);
                        tasks[1] = _contentView.TranslateTo(_platformHelper.GetScreenSize().Width - (CardPadding.Left), 0.0, 250, Easing.CubicInOut);
                        break;
                    default:
                        throw new ArgumentException(nameof(Edge));
                }

                tasks[2] = _overlay.FadeTo(0.0F, 150, Easing.CubicInOut);

                await Task.WhenAll(tasks);
            }

            await _platformHelper.CloseAsync (this);
		}

		#endregion
	}
}

